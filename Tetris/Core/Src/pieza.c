#include "pieza.h"
#include <math.h>

static const uint8_t FIGURAS[MAX_PIEZAS][4][4] = {
    // 0: Pieza I
    {
        {0,0,0,0, 1,1,1,1, 0,0,0,0, 0,0,0,0},
        {0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0},
        {0,0,0,0, 0,0,0,0, 1,1,1,1, 0,0,0,0},
        {0,1,0,0, 0,1,0,0, 0,1,0,0, 0,1,0,0}
    },
    // 1: Pieza J
    {
        {1,0,0,0, 1,1,1,0, 0,0,0,0, 0,0,0,0},
        {0,1,1,0, 0,1,0,0, 0,1,0,0, 0,0,0,0},
        {0,0,0,0, 1,1,1,0, 0,0,1,0, 0,0,0,0},
        {0,1,0,0, 0,1,0,0, 1,1,0,0, 0,0,0,0}
    },
    // 2: Pieza L
    {
        {0,0,1,0, 1,1,1,0, 0,0,0,0, 0,0,0,0},
        {0,1,0,0, 0,1,0,0, 0,1,1,0, 0,0,0,0},
        {0,0,0,0, 1,1,1,0, 1,0,0,0, 0,0,0,0},
        {1,1,0,0, 0,1,0,0, 0,1,0,0, 0,0,0,0}
    },
    // 3: Pieza O
    {
        {0,1,1,0, 0,1,1,0, 0,0,0,0, 0,0,0,0},
        {0,1,1,0, 0,1,1,0, 0,0,0,0, 0,0,0,0},
        {0,1,1,0, 0,1,1,0, 0,0,0,0, 0,0,0,0},
        {0,1,1,0, 0,1,1,0, 0,0,0,0, 0,0,0,0}
    },
    // 4: Pieza S
    {
        {0,1,1,0, 1,1,0,0, 0,0,0,0, 0,0,0,0},
        {0,1,0,0, 0,1,1,0, 0,0,1,0, 0,0,0,0},
        {0,0,0,0, 0,1,1,0, 1,1,0,0, 0,0,0,0},
        {1,0,0,0, 1,1,0,0, 0,1,0,0, 0,0,0,0}
    },
    // 5: Pieza T
    {
        {0,1,0,0, 1,1,1,0, 0,0,0,0, 0,0,0,0},
        {0,1,0,0, 0,1,1,0, 0,1,0,0, 0,0,0,0},
        {0,0,0,0, 1,1,1,0, 0,1,0,0, 0,0,0,0},
        {0,1,0,0, 1,1,0,0, 0,1,0,0, 0,0,0,0}
    },
    // 6: Pieza Z
    {
        {1,1,0,0, 0,1,1,0, 0,0,0,0, 0,0,0,0},
        {0,0,1,0, 0,1,1,0, 0,1,0,0, 0,0,0,0},
        {0,0,0,0, 1,1,0,0, 0,1,1,0, 0,0,0,0},
        {0,1,0,0, 1,1,0,0, 1,0,0,0, 0,0,0,0}
    }
};

void setForma(Pieza_t* me) {
    for (uint8_t i = 0; i < 4; i++)
        for (uint8_t j = 0; j < 4; j++)
            me->forma[i][j] = FIGURAS[me->tipo][me->rotacion][i * 4 + j];
}

void Pieza_Init(Pieza_t* me) {

    me->x = (uint8_t)(rand() % (TABLERO_ANCHO - PIEZA_ANCHO + 1));
    me->y = 0;
    me->tipo = (uint8_t)(rand() % MAX_PIEZAS);
    me->rotacion = (uint8_t)(rand() % 4);

    setForma(me);
}

void Pieza_Rotar(Pieza_t* me) {
    me->rotacion = (me->rotacion + 1) % 4;
    setForma(me);
}

void Pieza_Mover(Pieza_t* me, Direccion_t dir) {
    if (dir == IZQUIERDA) if (me->x > 0)me->x -= 1;
    else if (dir == DERECHA) me->x += 1;
    else if (dir == ABAJO) me->y += 1;
}

bool Pieza_GetBloque(Pieza_t* me, uint8_t i, uint8_t j) {
    if (i >= 4 || j >= 4) return false;
    return (me->forma[i][j]);
}
